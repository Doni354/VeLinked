<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - VeLinked</title>
    <!-- Di dalam elemen <head> -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/vendors/chartjs/Chart.min.css">
    <link rel="stylesheet" href="VL/css/attendance.css">
    <link rel="stylesheet" href="assets/vendors/perfect-scrollbar/perfect-scrollbar.css">
    <link rel="stylesheet" href="assets/css/app.css">
    <link rel="shortcut icon" href="assets/images/icon.svg" type="image/x-icon">
        <!-- include only the Firebase features as you need -->
        <script defer src="/__/firebase/10.9.0/firebase-app-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-auth-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-database-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-firestore-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-functions-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-messaging-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-storage-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-analytics-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-remote-config-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-performance-compat.js"></script>

        <script defer src="/__/firebase/init.js?useEmulator=true"></script>
</head>
<body>
    

<div id="alertContainer">
</div>
<!--</header>-->
    <div id="app" style="height: 100vh; display: flex;">
        <div id="sidebar" class='active'>
            <div class="sidebar-wrapper active">
    <div class="sidebar-header">
        <img src="assets/images/VL.svg" alt="" srcset="">
    </div>
    <div class="sidebar-menu">
        <ul class="menu">
            
            
                <li class='sidebar-title'>Main Menu</li>
            

                <li class="sidebar-item  ">
                    <a href="dashboard.html" class='sidebar-link'>
                        <img src="assets/images/Dash.svg" style="width: 20px;"> 
                        <span>Dashboard</span> 
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="Driver.html" class='sidebar-link'>
                        <img src="assets/images/Driver.svg" style="width: 20px;"> 
                        <span>Driver Data</span> 
                    </a>
                </li>

                <li class="sidebar-item ">
                    <a href="Expanse.html" class='sidebar-link'>
                        <img src="assets/images/Expanse.svg" style="width: 20px;"> 
                        <span>Expenses</span> 
                    </a>
                </li>
                <li class="sidebar-item active">
                    <a href="Attendance.html" class='sidebar-link'>
                        <img src="assets/images/AttendanceActive.svg" style="width: 20px;"> 
                        <span>Attendance</span> 
                    </a>
                </li>
                        
               
    </div>
    <button class="sidebar-toggler btn x"><i data-feather="x"></i></button>
</div>
        </div>
        <div id="main" style="flex: 1; background-color: white;">
            <nav class="navbar navbar-header navbar-expand navbar-light" style="background-color: white; padding-bottom: 100px;">
                <div style=" padding: 20px; margin-top: 100px;">
                    <b>
                      <strong><h3 style="font-weight: bold">Time & Attendance</h3></strong>
                    </b>
                  </div>
                <div style=" padding: 20px; margin-top: 50px;" class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav d-flex align-items-center navbar-light ml-auto">
                        <li class="dropdown">
                            <a href="#" data-toggle="dropdown" class="nav-link dropdown-toggle nav-link-lg nav-link-user">
                                <div id="profile-container" class="d-flex align-items-center">
                                    <div id="profile-picture" class="avatar mr-1"></div>
                                    <div class="d-none d-md-block d-lg-inline-block" id="user-name"></div>
                                </div>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right">
                                <a class="dropdown-item" href="profile.html"><i data-feather="user"></i> Account</a>
                                <a class="dropdown-item active" href="#"><i data-feather="mail"></i> Messages</a>
                                <a class="dropdown-item" href="#"><i data-feather="settings"></i> Settings</a>
                                <div class="dropdown-divider"></div>
                                <button class="dropdown-item" onclick="logout()"><i data-feather="log-out"></i> Logout</button>
                            </div>
                        </li>
                    </ul>
                </div>
                
            </nav>
            <div class="navbar-option">
                <div class="oprational-option">
                    <img src="assets/images/Oprational-option.svg" alt="">
                    Operational
                </div>
                <div class="ml-5 TimeOffReq-option option-active">
                    <img src="assets/images/TimeOffReq-option-Active.svg" alt="">
                    Time-Off Request
                </div>
            </div>
            <div class="request">
                <div class="request-option">
                    <h3>22 Request</h3>
                    <div class="request-tabs">
                        <button class="tab pending active">Pending <span class="badge">2</span></button>
                        <button class="tab approved">Approved <span class="badge">2</span></button>
                        <button class="tab rejected">Rejected <span class="badge">2</span></button>
                    </div>
                </div>
            </div>
            
            

<script>
    const tabs = document.querySelectorAll('.tab');

tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
    });
});

document.querySelectorAll('.navbar-option > div').forEach(function(option) {
    option.addEventListener('click', function() {
        // Menghapus class aktif dari semua opsi
        document.querySelectorAll('.navbar-option > div').forEach(function(opt) {
            opt.classList.remove('option-active');
            let img = opt.querySelector('img');
            let imgSrc = img.getAttribute('src').replace('-Active', '');
            img.setAttribute('src', imgSrc);
        });

        // Menambahkan class aktif pada opsi yang ditekan
        this.classList.add('option-active');
        let img = this.querySelector('img');
        let imgSrc = img.getAttribute('src').replace('.svg', '-Active.svg');
        img.setAttribute('src', imgSrc);
    });
});


</script>



<div class="table-header-container">
    <div class="table-header">
        <span class="header-item" style="width: 22%; text-align: left; ;">Name</span>
        <span class="header-item" style="width: 10%;">Duration</span>
        <span class="header-item" style="width: 20%;">Date</span>
        <span class="header-item" style="width: 15%;">Type</span>
        <span class="header-item" style="width: 15%;">Reason</span>
        <span class="header-item" style="width: 15%;">Approval</span>
    </div>
    <!-- TABEL DATA -->
    <div id="attendance-table" class="mt-2" style="border: #E6EDFF;">
        <div style="overflow-x:auto;">
            <table id="table-body" style="width: 100%; border-collapse: separate; border-spacing: 0; background-color: #fff; border-top: 2px solid #E6EDFF; border-bottom: 2px solid #E6EDFF; border-radius: 12px;">
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="overlay" class="overlay">
    <div class="overlay-content">
        <div class="head-overlay">
            <div>Time off details</div>
            <div>
                <button class="close-button" onclick="closeOverlay()">
                    <img src="assets/images/X-button.svg" alt="Close">
                </button>
            </div>
        </div>

        <div class="user-info">
            <div class="left-user-info">
                <img id="user-photo-overlay" src="assets/images/User_imgOverlay.svg" alt="User Image">
                <div class="user-details">
                    <h5 id="user-name-overlay">Hellyos Haqiqie</h5>
                    <p id="user-car-overlay">Using VOLVO Polestar 1</p>
                </div>
            </div>
            <div class="user-status">
                <img id="status-overlay" src="assets/images/PendingApproval.svg" alt="User Status">
            </div>
        </div>

        <div class="time-off-details">
            <div class="time-off-data">
                <div class="time-off">
                    <img src="assets/images/Line-TimeOffHead.svg" alt="">
                    <h5>Time off type</h5>
                    <span id="time-off-type-overlay">Sick Leave</span>
                </div>
                <div class="time-off">
                    <img src="assets/images/Line-TimeOffHead.svg" alt="">
                    <h5>Time off date</h5>
                    <span id="time-off-date-overlay">1st - 4th Jul 2024</span>
                </div>
                <div class="time-off">
                    <img src="assets/images/Line-TimeOffHead.svg" alt="">
                    <h5>Duration</h5>
                    <span id="duration-overlay">4 days</span>
                </div>
            </div>

            <div class="time-off-reason">
                <h5>Time off reason</h5>
                <div class="time-off-reason-dat">
                    <p id="reason-overlay">I have a fever today....</p>
                </div>
            </div>

            <div class="actions">
                <button class="reject">Reject</button>
                <button class="approve">Approve</button>
            </div>
        </div>
    </div>
</div>



<script>
    // Fungsi untuk menutup overlay
function closeOverlay() {
    document.getElementById("overlay").classList.remove("open");
}
</script>



    
<script type="module">
    // Import Firebase SDK
    import { getDatabase, ref as dbRef, onValue, update } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyB9qUzLViR5uALw9Qf_xzJpd20acoV0FEs",
        authDomain: "velinked-web.firebaseapp.com",
        databaseURL: "https://velinked-web-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "velinked-web",
        storageBucket: "velinked-web.appspot.com",
        messagingSenderId: "844821073092",
        appId: "1:844821073092:web:f243c25668079240ec0d91",
        measurementId: "G-CLGQ4RWWTX"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    // Fungsi untuk mengambil ID user yang sedang login
    onAuthStateChanged(auth, (user) => {
        if (user) {
            const userId = user.uid;
            getDriverData(userId);
        } else {
            console.log('User not logged in');
        }
    });

    // Fungsi untuk mengambil data driver dari node Drivers berdasarkan userId
    function getDriverData(userId) {
        const driversRef = dbRef(db, 'Drivers');
        onValue(driversRef, (snapshot) => {
            snapshot.forEach((driverDoc) => {
                const driverData = driverDoc.val();
                if (driverData.userId === userId) {
                    const driverId = driverDoc.key;
                    const fullName = driverData.fullName;
                    const driverPhotoUrl = driverData.driverPhotoUrl;

                    // Setelah mendapatkan driverId, ambil data Attendances
                    getAttendanceData(driverId, fullName, driverPhotoUrl);
                }
            });
        });
    }

    // Fungsi untuk menambahkan suffix pada tanggal
    function getDateWithSuffix(date) {
        const day = date.getDate();
        const suffix = (day === 1 || day === 21 || day === 31) ? 'st' :
                       (day === 2 || day === 22) ? 'nd' :
                       (day === 3 || day === 23) ? 'rd' : 'th';
        return `${day}${suffix}`;
    }

    // Fungsi untuk format bulan dalam 3 huruf pertama
    function getShortMonth(monthIndex) {
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        return months[monthIndex];
    }

// Fungsi untuk menambahkan ordinal (st, nd, rd, th) pada tanggal
function getOrdinalDate(date) {
    const day = date.getDate();
    if (day > 3 && day < 21) return day + 'th'; // Umum untuk 11-19
    switch (day % 10) {
        case 1: return day + 'st';
        case 2: return day + 'nd';
        case 3: return day + 'rd';
        default: return day + 'th';
    }
}

// Fungsi untuk memformat rentang tanggal
function formatDateRange(from, to) {
    const fromDay = getOrdinalDate(from);
    const toDay = getOrdinalDate(to);

    const fromMonth = from.toLocaleString('default', { month: 'short' });
    const toMonth = to.toLocaleString('default', { month: 'short' });

    const year = from.getFullYear(); // Tahun ditampilkan hanya sekali

    // Jika bulan sama, tampilkan bulan dan tahun hanya sekali
    if (fromMonth === toMonth) {
        return `${fromDay} - ${toDay} ${fromMonth} ${year}`;
    } else {
        return `${fromDay} ${fromMonth} - ${toDay} ${toMonth} ${year}`;
    }
}

// Fungsi untuk membuka overlay dan mengisi data dari Firebase
function openOverlay(attendanceData, fullName, driverPhotoUrl, attendanceId) {
    document.getElementById("overlay").classList.add("open");

    // Isi data di overlay dengan data dari Firebase
    document.getElementById("user-name-overlay").textContent = fullName;
    document.getElementById("user-photo-overlay").src = driverPhotoUrl;
    document.getElementById("time-off-type-overlay").textContent = attendanceData.type;

    const from = new Date(attendanceData.from);
    const to = new Date(attendanceData.to);
    const dateRange = formatDateRange(from, to);
    document.getElementById("time-off-date-overlay").textContent = dateRange;

    const duration = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1;
    document.getElementById("duration-overlay").textContent = `${duration} days`;

    document.getElementById("reason-overlay").textContent = attendanceData.desc || "No reason provided";

    // Ubah status gambar sesuai status
    let statusImage = 'assets/images/PendingApproval.svg'; // Default pending
    if (attendanceData.status === 'approved') {
        statusImage = 'assets/images/Approved.svg';
    } else if (attendanceData.status === 'rejected') {
        statusImage = 'assets/images/Rejected.svg';
    }
    document.getElementById("status-overlay").src = statusImage;

    // Tambahkan event listener ke tombol "Reject" dan "Approve"
    document.querySelector('.reject').addEventListener('click', () => {
        updateAttendanceStatus(attendanceId, 'rejected');
    });

    document.querySelector('.approve').addEventListener('click', () => {
        updateAttendanceStatus(attendanceId, 'approved');
    });
}

// Fungsi untuk memperbarui status di Firebase
function updateAttendanceStatus(attendanceId, newStatus) {
    const attendanceRef = dbRef(db, `Attendances/${attendanceId}`);
    
    // Perbarui status di Firebase
    update(attendanceRef, { status: newStatus })
        .then(() => {
            console.log(`Status updated to ${newStatus}`);
            closeOverlay();  // Tutup overlay setelah berhasil
        })
        .catch((error) => {
            console.error("Error updating status: ", error);
        });
}

// Fungsi untuk menutup overlay
function closeOverlay() {
    document.getElementById("overlay").classList.remove("open");
}



// Fungsi untuk mengambil data Attendances dan menambahkan event listener untuk membuka overlay
function getAttendanceData(driverId, fullName, driverPhotoUrl) {
    const attendancesRef = dbRef(db, 'Attendances');
    
    // Gunakan onValue untuk memantau perubahan secara real-time
    onValue(attendancesRef, (snapshot) => {
        let tableBody = document.getElementById('table-body');
        
        // Bersihkan isi tabel sebelum menambahkan data baru
        tableBody.innerHTML = ''; 
        
        let rowIndex = 0;

        snapshot.forEach((attendanceDoc) => {
            const attendanceData = attendanceDoc.val();
            const attendanceId = attendanceDoc.key; // Dapatkan ID dari dokumen attendance

            if (attendanceData.driverId === driverId) {
                const from = new Date(attendanceData.from);
                const to = new Date(attendanceData.to);
                const duration = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1;
                const dateRange = formatDateRange(from, to);
                const type = attendanceData.type;
                const status = attendanceData.status;

                let approvalText = '';
                let approvalImage = '';

                if (status === 'pending') {
                    approvalText = '';
                    approvalImage = '<img style="margin-right: 8px;" src="assets/images/Approved_Option.svg" alt=""><img src="assets/images/Rejected_Option.svg" alt="">';
                } else if (status === 'approved') {
                    approvalText = 'Approved';
                    approvalImage = '<img src="assets/images/Approved-img.svg" alt="Approved">';
                } else if (status === 'rejected') {
                    approvalText = 'Rejected';
                    approvalImage = '<img src="assets/images/Rejected-img.svg" alt="Rejected">';
                }


                let row = document.createElement('tr');
                row.classList.add((rowIndex % 2 === 0) ? 'table-row-even' : 'table-row-odd');

                row.innerHTML = `
                <td class="table-data username" style="width: 23%;">
                        <img src="${driverPhotoUrl}" alt="Driver Photo" class="driver-photo"> ${fullName}
                      </td>
                      <td class="table-data" style="width: 9%;">${duration} Days</td>
                      <td class="table-data" style="width: 20%;">${dateRange}</td>
                      <td class="table-data" style="width: 15%;">${type}</td>
                      <td class="table-data" style="width: 15%;"><img src="assets/images/Reason.svg" alt="Reason"></td>
                      <td class="table-data" style="width: 15%; color: #092448; font-weight: bold;">
                        ${approvalImage} ${approvalText}
                      </td>
                `;

                // Tambahkan event listener pada setiap baris tabel untuk membuka overlay
                row.addEventListener('click', () => {
                    openOverlay(attendanceData, fullName, driverPhotoUrl, attendanceId);
                });

                tableBody.appendChild(row);
                rowIndex++;
            }
        });
    });
}








    
</script>







    
    <script src="js/UserAndStatus_check.js"></script>


      
    
        


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="assets/js/feather-icons/feather.min.js"></script>
    <script src="assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script src="assets/js/app.js"></script>
    
    <script src="assets/vendors/chartjs/Chart.min.js"></script>
    <script src="assets/vendors/apexcharts/apexcharts.min.js"></script>
    <script src="assets/js/pages/dashboard.js"></script>

    <script src="assets/js/main.js"></script>
    
    <script src="js/a-auth.js"></script>
    <script src="js/a-pp.js"></script>

  
</body>
</html>
