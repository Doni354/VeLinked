<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - VeLinked</title>
    <!-- Di dalam elemen <head> -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="assets/vendors/chartjs/Chart.min.css">
    <link rel="stylesheet" href="VL/css/expanse.css">
    <link rel="stylesheet" href="assets/vendors/perfect-scrollbar/perfect-scrollbar.css">

    <link rel="shortcut icon" href="assets/images/icon.svg" type="image/x-icon">
        <!-- include only the Firebase features as you need -->
        <script defer src="/__/firebase/10.9.0/firebase-app-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-auth-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-database-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-firestore-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-functions-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-messaging-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-storage-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-analytics-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-remote-config-compat.js"></script>
        <script defer src="/__/firebase/10.9.0/firebase-performance-compat.js"></script>

        <script defer src="/__/firebase/init.js?useEmulator=true"></script>
</head>
<body>
    

<!--</header>-->
    <div id="app" style="height: 100vh; display: flex;">
        <div id="sidebar" class='active'>
            <div class="sidebar-wrapper active">
    <div class="sidebar-header">
        <img src="assets/images/VL.svg" alt="" srcset="">
    </div>
    <div class="sidebar-menu">
        <ul class="menu">
            
            
                <li class='sidebar-title'>Main Menu</li>
            

                <li class="sidebar-item  ">
                    <a href="dashboard.html" class='sidebar-link'>
                        <img src="assets/images/Dash.svg" style="width: 20px;"> 
                        <span>Dashboard</span> 
                    </a>
                </li>
                <li class="sidebar-item ">
                    <a href="Driver.html" class='sidebar-link'>
                        <img src="assets/images/Driver.svg" style="width: 20px;"> 
                        <span>Driver Data</span> 
                    </a>
                </li>
                <li class="sidebar-item active ">
                    <a href="Expanse.html" class='sidebar-link'>
                        <img src="assets/images/ExpanseActive.svg" style="width: 20px;"> 
                        <span>Expenses</span> 
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="Attendance.html" class='sidebar-link'>
                        <img src="assets/images/Attendance.svg" style="width: 20px;"> 
                        <span>Attendance</span> 
                    </a>
                </li>
                        
               
    </div>
    <button class="sidebar-toggler btn x"><i data-feather="x"></i></button>
</div>
        </div>
        <div id="main" style="background: white;">
            
            

            
            <div class="main-content">
                <div class="left-content">
                    <div class="title-name">
                        <div class="title-up">
                            <div class="p-bold nickname-daily">
                                <p id="vehicleNickname">Polestar A1 </p>
                                <button class="daily-button" id="dailyButton">weekly</button>
                            </div>
                            <div class="title-stats">
                                <p id="vehicleStatus">In Transit</p>
                            </div>
                        </div>
                        <div class="h2-bold brand-name">
                            <h2 id="vehicleBrand">Volvo, </h2>
                            <h2 id="vehicleName">Polestar 1</h2>
                        </div>
                    </div>
                    
                    <div class="user-container">
                        <div class="user1">
                            <img class="pp" src="assets/images/userDummy.svg" alt="">
                            <div class="username h2-bold mt-3">
                                <h2>Hellyos Haqiqie</h2>
                                <p>Using VOLVO Polestar 1</p>
                            </div>
                            <img class="mt-2 toggle-btn" src="assets/images/shapeOpen.svg" alt="">
                        </div>
                        <div class="additional-info">
                        </div>
                    </div>                 
                    
                    








                    
                    <hr class="custom-line">

                    <div class="vehicle">
                        <div class="vehicle-title h2-bold p-bold">
                            <div class="h2-bold brand-name">
                                <h2 id="vehicleBrandExpenses">Volvo, </h2>
                                <h2 id="vehicleNameExpenses">Polestar 1</h2>
                            </div>
                            <p>Vehicle Expenses</p>
                        </div>
                        <div class="vehicle-detail">
                            <div class="vehicle-data">
                                <div class="left-data">
                                    <div class="data">
                                        <h5>Gas station</h5>
                                        <p id="Gas">Rp 0,00</p>
                                    </div>
                                    <div class="data">
                                        <h5>Highway</h5>
                                        <p id="Toll">Rp 0,00</p>
                                    </div>
                                    <div class="data">
                                        <h5>ERP</h5>
                                        <p id="ERP">Rp 0,00</p>
                                    </div> 
                                </div>
                                <div class="right-data">
                                    <div class="data">
                                        <h5>Car Wash</h5>
                                        <p id="CarWash">Rp 0,00</p>
                                    </div>
                                    <div class="data">
                                        <h5>Parking</h5>
                                        <p id="Parking">Rp 0,00</p>
                                    </div>
                                </div>
                                
                            </div>
                            <div class="vehicle-img">
                                <img id="vehiclePictureExpenses" src="assets/images/carExpanse.svg" alt="Vehicle Picture">
                            </div>
                        </div>
                    </div>

                    <div class="expanses">
                        <div class="expanses-title">
                            <div class="title-expanses h2-bold p-bold">
                                <h2>Hellyos Haqiqie</h2>
                                <p>Driver Expenses & Driving Behavior</p>
                            </div>
                            <div class="img-expanses">
                                <img src="assets/images/userDummyExpanse.svg" alt="">
                            </div>
                        </div>
                        <div class="expanse-detail">
                            <div class="vehicle-data">
                                <div class="left-data">
                                    <div class="data">
                                        <h5>Consumption</h5>
                                        <p id="Consumptions">Rp 0,00</p>
                                    </div>
                                    <div class="data">
                                        <h5>Insurance</h5>
                                        <p id="Maintenance">Rp 0,00</p>
                                    </div>
                                    <div class="data">
                                        <h5>Traffic Ticket</h5>
                                        <p id="Ticket">Rp 0,00</p>
                                    </div>
                                </div>
                                <div class="right-data">
                                    <div class="data">
                                        <h5>Avg. Speed</h5>
                                        <p style="color: #89E381;">54 Km/h</p>
                                    </div>
                                    <div class="data">
                                        <h5>Driving Behavior</h5>
                                        <p style="color: #89E381;">Safe</p>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                        <div class="driverdoc">
                            <div class="driverdoc-tittle p-bold">
                                <p>Driver Documment</p>
                            </div>
                            <div class="driver-doc">
                                <div class="doc">
                                    <div class="doc-name">
                                        <h5>Driver License</h5>
                                        <p>Attached</p> 
                                    </div>
                                    <div class="doc-view">
                                        <img style="visibility: hidden;" src="assets/images/viewDoc.svg" alt="">
                                    </div>
                                </div>
                                <div class="doc">
                                    <div class="doc-name">
                                        <h5>VeCard</h5>
                                        <p>Attached</p> 
                                    </div>
                                    <div class="doc-view">
                                        <img style="visibility: hidden;" src="assets/images/viewDoc.svg" alt="">
                                    </div>
                                </div>
                                <div class="doc">
                                    <div class="doc-name">
                                        <h5>Identity Card</h5>
                                        <p>Attached</p> 
                                    </div>
                                    <div class="doc-view">
                                        <img style="visibility: hidden;" src="assets/images/viewDoc.svg" alt="">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="right-content">
                    <div class="loc-expanse">
                        <img src="assets/images/expanseDummy.svg" alt="">
                    </div>

                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { getDatabase, ref as dbRef, onValue } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB9qUzLViR5uALw9Qf_xzJpd20acoV0FEs",
            authDomain: "velinked-web.firebaseapp.com",
            databaseURL: "https://velinked-web-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "velinked-web",
            storageBucket: "velinked-web.appspot.com",
            messagingSenderId: "844821073092",
            appId: "1:844821073092:web:f243c25668079240ec0d91",
            measurementId: "G-CLGQ4RWWTX"
        };
    
        // Firebase Initialization
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
    
        // Mengambil UID user yang sedang login
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const uid = user.uid;
                loadDrivers(uid);
            } else {
                console.error("User not logged in");
            }
        });
    
        // Fungsi untuk memuat data Drivers berdasarkan UID user yang login
        function loadDrivers(uid) {
            const driversRef = dbRef(db, 'Drivers');
    
            onValue(driversRef, (snapshot) => {
                const driversData = snapshot.val();
                const driverList = [];
    
                for (const driverId in driversData) {
                    const driver = driversData[driverId];
    
                    if (driver.userId === uid) {
                        driver.id = driverId; // Menambahkan id ke driver
                        driverList.push(driver); // Tambahkan driver ke list
                    }
                }
    
                if (driverList.length > 0) {
                    loadUser1(driverList[0]);
                    driverList.forEach(driver => {
                        loadDropdownDriver(driver);
                    });
                    loadVehicleData(driverList[0].vehicleUsed); // Memuat data kendaraan untuk driver pertama
                }
            });
        }
    
        // Fungsi untuk memuat data ke user1
        function loadUser1(driver) {
            const vehicleRef = dbRef(db, `Vehicle/${driver.vehicleUsed}`);
            onValue(vehicleRef, (vehicleSnapshot) => {
                const vehicleData = vehicleSnapshot.val();
                
                document.querySelector('.user1 img').src = driver.driverPhotoUrl || 'assets/images/userDummy.svg';
                document.querySelector('.user1 h2').textContent = driver.fullName;
                document.querySelector('.user1 p').textContent = `Using ${vehicleData.nickname}`;
                
                updateURL(driver.id); // Update URL parameter
                loadVehicleData(driver.vehicleUsed); // Memuat data kendaraan
                loadVehicleDataExpenses(driver.vehicleUsed);
            });
        }
    
        // Fungsi untuk memuat data kendaraan
        function loadVehicleData(vehicleUsed) {
            const vehicleRef = dbRef(db, `Vehicle/${vehicleUsed}`);
            onValue(vehicleRef, (vehicleSnapshot) => {
                const vehicleData = vehicleSnapshot.val();
    
                // Menampilkan data kendaraan
                document.getElementById('vehicleNickname').textContent = vehicleData.nickname;
                document.getElementById('vehicleBrand').textContent = vehicleData.brand + ', '; // Menambahkan koma
                document.getElementById('vehicleName').textContent = vehicleData.name; // Mengisi nama kendaraan
            });
        }

        function loadVehicleDataExpenses(vehicleUsed) {
        const vehicleRef = dbRef(db, `Vehicle/${vehicleUsed}`);
        onValue(vehicleRef, (vehicleSnapshot) => {
            const vehicleData = vehicleSnapshot.val();
            
            // Menampilkan data kendaraan
            document.getElementById('vehicleBrandExpenses').textContent = vehicleData.brand + ', '; // Menambahkan koma
            document.getElementById('vehicleNameExpenses').textContent = vehicleData.name; // Mengisi nama kendaraan

            // Menampilkan gambar kendaraan
            const vehiclePicture = vehicleData.picture ? vehicleData.picture : 'assets/images/carExpanse.svg'; // Gambar default jika tidak ada
            document.getElementById('vehiclePictureExpenses').src = vehiclePicture;
        });
    }
    
        // Fungsi untuk memuat data driver ke dropdown
        function loadDropdownDriver(driver) {
            const vehicleRef = dbRef(db, `Vehicle/${driver.vehicleUsed}`);
            onValue(vehicleRef, (vehicleSnapshot) => {
                const vehicleData = vehicleSnapshot.val();
    
                const dropdownContainer = document.querySelector('.additional-info');
                const dropdownItem = document.createElement('div');
                dropdownItem.classList.add('user');
                dropdownItem.innerHTML = `
                    <img src="${driver.driverPhotoUrl || 'assets/images/userDummy.svg'}" alt="">
                    <div class="username h2-bold mt-3 ml-4">
                        <h2>${driver.fullName}</h2>
                        <p>Using ${vehicleData.nickname}</p>
                    </div>
                `;
    
                dropdownItem.addEventListener('click', () => {
                    loadUser1(driver);
                    closeDropdown();
                    loadVehicleData(driver.vehicleUsed);
                    loadVehicleDataExpenses(driver.vehicleUsed);
                    loadExpenses(driver.id);
                });
    
                dropdownContainer.appendChild(dropdownItem);
            });
        }
    
        // Fungsi untuk memperbarui URL parameter
        function updateURL(driverId) {
            const currentURL = new URL(window.location);
            currentURL.searchParams.set('driverId', driverId);
            window.history.pushState({}, '', currentURL);
        }
    
        // Fungsi untuk menutup dropdown
        function closeDropdown() {
            const container = document.querySelector('.user-container');
            const user1 = document.querySelector('.user1');
            
            container.classList.remove('expand');
            user1.style.marginTop = '20px';
            container.style.maxHeight = '75px'; // Kembali ke tinggi awal
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.toggle-btn').addEventListener('click', function() {
                const container = document.querySelector('.user-container');
                const user1 = document.querySelector('.user1');
                const dailyButton = document.getElementById('dailyButton');
                const states = ['weekly', 'monthly', 'yearly'];
                let currentIndex = 0;

                dailyButton.addEventListener('click', () => {
                    currentIndex = (currentIndex + 1) % states.length;
                    dailyButton.textContent = states[currentIndex];
                });


                if (container.classList.contains('expand')) {
                    closeDropdown();
                } else {
                    container.classList.add('expand');
                    user1.style.marginTop = '0px';
                    container.style.maxHeight = '300px'; // Tinggi baru setelah dropdown dibuka
                }
            });
        });





        // Fungsi untuk memuat data Expenses berdasarkan driverId
function loadExpenses(driverId) {


    // Inisialisasi map untuk setiap tipe dengan nilai 0
const expensesMap = {
    Gas: 0,
    Toll: 0,
    ERP: 0,
    Consumptions: 0,
    Maintenance: 0,
    CarWash: 0,
    Parking: 0,
    Ticket: 0
};

// Ambil data Expenses dari Firebase berdasarkan driverId
const expensesRef = firebase.database().ref('Expenses').orderByChild('driverId').equalTo(driverId);

expensesRef.once('value', (snapshot) => {
    if (snapshot.exists()) {
        snapshot.forEach((doc) => {
            const data = doc.val();
            const price = parseFloat(data.price) || 0;
            const type = data.type;

            // Tambahkan price ke dalam tipe yang sesuai di expensesMap
            if (expensesMap.hasOwnProperty(type)) {
                expensesMap[type] += price;
            } else {
                console.warn(`Unknown type: ${type}`);
            }
        });
    }

    // Tampilkan hasil di elemen <p> yang sesuai
    for (const type in expensesMap) {
        const totalPrice = expensesMap[type];
        const element = document.getElementById(type);

        // Pastikan elemen ada sebelum mengubah textContent
        if (element) {
            element.textContent = `${totalPrice.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' })}`;
        } else {
            console.warn(`Element with ID "${type}" not found`);
        }
    }
});

}



    </script>
    
      















    
    
        
        

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="assets/js/feather-icons/feather.min.js"></script>
    <script src="assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script src="assets/js/app.js"></script>
    
    <script src="assets/vendors/chartjs/Chart.min.js"></script>
    <script src="assets/vendors/apexcharts/apexcharts.min.js"></script>
    <script src="assets/js/main.js"></script>
    


  
</body>
</html>
