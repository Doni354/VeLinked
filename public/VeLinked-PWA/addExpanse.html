<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeLinked Driver</title>
    <link rel="stylesheet" href="css/navbar.css">
    <link rel="stylesheet" href="css/addExpanse.css">
    
    <script defer src="/__/firebase/10.9.0/firebase-app-compat.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/10.9.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/10.9.0/firebase-database-compat.js"></script>
    <script defer src="/__/firebase/10.9.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/10.9.0/firebase-functions-compat.js"></script>
    <script defer src="/__/firebase/10.9.0/firebase-messaging-compat.js"></script>
    <script defer src="/__/firebase/10.9.0/firebase-storage-compat.js"></script>
    <script defer src="/__/firebase/10.9.0/firebase-analytics-compat.js"></script>
    <script defer src="/__/firebase/10.9.0/firebase-remote-config-compat.js"></script>
    <script defer src="/__/firebase/10.9.0/firebase-performance-compat.js"></script>
    <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
    
</head>
<body>

    <div class="header">
        <h2>Input your expenses</h2>

    </div>

    <div class="main-content">
        <div class="camera-container">
            <video id="camera-stream" autoplay playsinline></video>
            <canvas id="snapshot"></canvas>
            <img id="photo-preview" src="" alt="Photo preview" style="display:none;"/>
            <input type="file" id="image-file" accept="image/*" style="display:none;">
          
            <div class="controls">
                <img id="take-photo" src="assets/images/Photo.svg" alt="Take Photo">
                <img id="retake-photo" src="assets/images/Retake.svg" alt="Retake" style="display:none;">
            </div>
        </div>

        <!-- Form input expense -->
        <form class="expense-form" id="expense-form">
            <div class="form-group">
                <label for="expense-amount">Input your expense</label>
                <input type="number" id="expense-amount" name="expense-amount" placeholder="0.00" required>
            </div>

            <div class="form-group">
                <label for="expense-type">Expense type</label>
                <select id="expense-type" name="expense-type" required>
                    <option value="" disabled selected>Select type</option>
                    <option value="Gas">Gas</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Toll">Toll</option>
                    <option value="Parking">Parking</option>
                </select>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <input type="text" id="description" name="description" placeholder="description..." required>
            </div>

            <button type="submit" class="submit-button">Add New Expense</button>
        </form>
    </div>
      
      
<div class="popup" id="popup"></div>
    


    <div class="navbar">
        <a href="dashboard.html">
            <img src="assets/images/Nav-Dashboard.svg" alt="Dashboard" width="24" height="24">
        </a>
        <a href="Expanse.html">
            <img src="assets/images/Nav-Expanse-Active.svg" alt="Expanse" width="24" height="24">
        </a>
        <a href="#">
            <img src="assets/images/Nav-Attendance.svg" alt="Chat" width="24" height="24">
        </a>
        <a href="Profile.html">
            <img src="assets/images/Nav-Profile.svg" alt="Profile" width="24" height="24">
        </a>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
        import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyB9qUzLViR5uALw9Qf_xzJpd20acoV0FEs",
            authDomain: "velinked-web.firebaseapp.com",
            databaseURL: "https://velinked-web-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "velinked-web",
            storageBucket: "velinked-web.appspot.com",
            messagingSenderId: "844821073092",
            appId: "1:844821073092:web:f243c25668079240ec0d91",
            measurementId: "G-CLGQ4RWWTX"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);
    
        const form = document.getElementById('expense-form');
        const photoPreview = document.getElementById('photo-preview');
        const popup = document.getElementById('popup');  // Elemen popup notifikasi
        const cameraStream = document.getElementById('camera-stream');

        const takePhotoBtn = document.getElementById('take-photo');
        const retakePhotoBtn = document.getElementById('retake-photo');
        const snapshotCanvas = document.getElementById('snapshot');

        let stream;

        // Fungsi untuk memulai kamera belakang
        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(function(mediaStream) {
                stream = mediaStream;
                cameraStream.srcObject = stream;
            })
            .catch(function(err) {
                console.error('Error accessing camera: ', err);
            });
        }

        // Fungsi untuk mengambil foto
        function takePhoto() {
            const context = snapshotCanvas.getContext('2d');
            snapshotCanvas.width = cameraStream.videoWidth;
            snapshotCanvas.height = cameraStream.videoHeight;
            context.drawImage(cameraStream, 0, 0);
            
            const dataUrl = snapshotCanvas.toDataURL('image/png');
            photoPreview.src = dataUrl;
            photoPreview.style.display = 'block';
            cameraStream.style.display = 'none';
            
            retakePhotoBtn.style.display = 'inline';
            takePhotoBtn.style.display = 'none';
        }

        // Fungsi untuk foto ulang
        function retakePhoto() {
            photoPreview.src = '';
            photoPreview.style.display = 'none';
            cameraStream.style.display = 'block';
            
            retakePhotoBtn.style.display = 'none';
            takePhotoBtn.style.display = 'inline';
        }

        // Event listener
        takePhotoBtn.addEventListener('click', takePhoto);
        retakePhotoBtn.addEventListener('click', retakePhoto);

        // Jalankan kamera saat halaman dimuat
        startCamera();

        // Fungsi untuk menampilkan notifikasi popup
        function showPopup(message, type = 'info') {
            popup.textContent = message;
            popup.className = `popup ${type}`;
            popup.style.display = 'block';
            setTimeout(() => {
                popup.style.display = 'none';
            }, 8000);
        }
    
        // Fungsi untuk submit form
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // Ambil nilai input form
            const expenseAmount = document.getElementById('expense-amount').value;
            const expenseType = document.getElementById('expense-type').value;
            const description = document.getElementById('description').value;
            const photo = photoPreview.src;
    
            // Validasi input
            if (!expenseAmount || !expenseType || !description || !photo) {
                showPopup('All fields including photo are required!', 'error');
                return;
            }
    
            // Tampilkan popup "sedang dikirim"
            showPopup('Sending data...', 'info');
    
            try {
                // Generate nama file untuk foto
                const photoFileName = `expense_${Date.now()}.png`;
    
                // Upload foto ke Firebase Storage
                const photoStorageRef = storageRef(storage, `Expenses/Image/${photoFileName}`);
                await uploadString(photoStorageRef, photo, 'data_url');
    
                // Dapatkan URL download untuk foto yang diupload
                const photoUrl = await getDownloadURL(photoStorageRef);
    
                // Persiapkan data untuk Realtime Database
                const expenseData = {
                    price: expenseAmount,
                    type: expenseType,
                    desc: description,
                    photo: photoUrl
                };
    
                // Kirim data ke Realtime Database
                const expenseRef = ref(database, 'Expenses');
                await push(expenseRef, expenseData);
    
                // Tampilkan popup "berhasil dikirim"
                showPopup('Expense successfully added!', 'success');
                form.reset();
                photoPreview.src = '';
                photoPreview.style.display = 'none';
                cameraStream.style.display = 'block';
                retakePhoto();
                // Redirect ke halaman Expanse.html
                setTimeout(() => {
                    window.location.href = 'Expanse.html';
                }, 2000);
            } catch (error) {
                console.error('Error uploading data: ', error);
                showPopup('Failed to send data. Please try again.', 'error');
            }
        });
    </script>
    

    <script>
        
        
    </script>
</body>
</html>
